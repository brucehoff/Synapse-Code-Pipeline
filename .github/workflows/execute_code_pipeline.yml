---
#
# This workflow deploys an AWS Code Pipeline (CP) and then runs it. If the CP
# already exists it does not recreate it.
#
name: main

on:
  workflow_call:
    inputs:
      REPOSITORY_NAME:
        required: false
        type: string
        description: Repository containing the pipeline CloudFormation definition, defaults to current repo'
      REPOSITORY_BRANCH:
        required: false
        type: string
        description: Branch containing the pipeline CloudFormation definition, defaults to current branch
      CODE_PIPELINE_CF_TEMPLATE:
        required: true
        type: string
        description: file path for pipeline CF definition
      PIPELINE_NAME:
        required: true
        type: string
        description: name of pipeline
      PIPELINE_PARAMETERS:
        required: true
        type: string
        description: cloudformation parameters for pipeline set-up
      CODE_PIPELINE_SOURCE_REVISIONS:
        required: false
        type: string
        description: value of the 'source-revisions' code pipeline parameter
      ROLE_TO_ASSUME:
        required: true
        type: string
        description: AWS role to assume to set up code pipeline
      STATUS_REPO_OWNER:
        required: false
        type: string
        description: GitHub repo' owner where build status is to be published
      STATUS_REPOSITORY:
        required: false
        type: string
        description: GitHub repository where build status is to be published

# let only one invocation of a pipeline run at a time
concurrency:
  group: ${{ inputs.PIPELINE_NAME }}

jobs:
  build_and_test:
    permissions:
      # https://graphite.dev/guides/github-actions-permissions
      id-token: write
      contents: read
      deployments: write
      security-events: write
      statuses: write
      actions: write
      checks: write

    runs-on: ubuntu-latest

    steps:
      - id: oidc
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ inputs.ROLE_TO_ASSUME }}
          aws-region: us-east-1
          # eight hours
          role-duration-seconds: 28800

      - name: get app credentials
        id: app-creds
        run: |
          github_app_credentials=$(aws secretsmanager get-secret-value --secret-id "/build/github/app/credentials" --query SecretString --output text)
          echo "APP_ID=$(echo $github_app_credentials | jq -r '.APP_ID')" >> $GITHUB_OUTPUT
          # Note, in Secrets Manager the secret is a pem file, but with new lines represented as underscores
          # So here we replace the underscores with new lines
          APP_PRIVATE_KEY_WITH_UNDERSCORES=$(echo $github_app_credentials | jq -r '.PRIVATE_KEY')
          echo "APP_PRIVATE_KEY=$(echo $APP_PRIVATE_KEY_WITH_UNDERSCORES | sed s/_/'\\n'/g)" >> $GITHUB_OUTPUT

      - uses: actions/create-github-app-token@v2
        id: app-token
        if: ${{ github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        with:
          app-id: ${{ steps.app-creds.outputs.APP_ID }}
          private-key: ${{ steps.app-creds.outputs.APP_PRIVATE_KEY }}
          owner: ${{ inputs.STATUS_REPO_OWNER }}
          repositories: ${{ inputs.STATUS_REPOSITORY }}

      # 'checkout' is required to be able to reference 'CODE_PIPELINE_CF_TEMPLATE' in the next step
      - name: checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.REPOSITORY_NAME }}
          ref: ${{ inputs.REPOSITORY_BRANCH }}

      - name: Deploy CodePipeline to AWS CloudFormation
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        id: pipeline-deploy
        with:
          template: ${{ inputs.CODE_PIPELINE_CF_TEMPLATE }}
          name: ${{ inputs.PIPELINE_NAME }}
          capabilities: CAPABILITY_IAM,CAPABILITY_NAMED_IAM
          parameter-overrides: ${{ inputs.PIPELINE_PARAMETERS }},GitHubToken=${{ secrets.GITHUB_TOKEN }}

      - name: Output Pipeline Console URL
        run: |
          echo "PIPELINE_CONSOLE_URL=https://us-east-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/${{ steps.pipeline-deploy.outputs.PipelineName }}/view" >> $GITHUB_ENV

      - name: Pending Status
        if: ${{ github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh api --method POST \
          /repos/${{ inputs.STATUS_REPO_OWNER }}/${{ inputs.STATUS_REPOSITORY }}/statuses/${{ github.sha }} \
          -f "state=pending" \
          -f "description=Build in Progress" \
          -f "target_url=${{ env.PIPELINE_CONSOLE_URL }}"

      - name: Trigger CodePipeline
        id: pipeline-run
        run: |
          EXECUTION_ID=$(aws codepipeline start-pipeline-execution \
            --name ${{ steps.pipeline-deploy.outputs.PipelineName }} \
            --source-revisions ${{ inputs.CODE_PIPELINE_SOURCE_REVISIONS }} \
            --query 'pipelineExecutionId' --output text)

          echo "EXECUTION_ID=$EXECUTION_ID" >> $GITHUB_ENV

          # if the status check is too soon, the executing pipeline is not found and the workflow fails
          sleep 10

          # Wait for completion
          while true; do
            STATUS=$(aws codepipeline get-pipeline-execution --pipeline-name ${{ steps.pipeline-deploy.outputs.PipelineName }} \
              --pipeline-execution-id $EXECUTION_ID --query "pipelineExecution.status" --output text)

            if [[ "$STATUS" == "Succeeded" ]]; then
              echo "Pipeline execution $EXECUTION_ID succeeded."
              break
            elif [[ "$STATUS" == "InProgress" ]]; then
              echo "Pipeline execution $EXECUTION_ID is still in progress. Current status: $STATUS. Waiting..."
              sleep 30 # Wait for 30 seconds before checking again
            else
              echo "Pipeline execution $EXECUTION_ID terminated with: $STATUS"
              exit 1
            fi
          done

        # since app credentials only last an hour we have to get new ones
      - uses: actions/create-github-app-token@v2
        if: ${{ always() && github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        id: app-token-2
        with:
          app-id: ${{ steps.app-creds.outputs.APP_ID }}
          private-key: ${{ steps.app-creds.outputs.APP_PRIVATE_KEY }}
          owner: ${{ inputs.STATUS_REPO_OWNER }}
          repositories: ${{ inputs.STATUS_REPOSITORY }}


      - name: Success Status
        if: ${{ github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token-2.outputs.token }}
        run: |
          gh api --method POST \
          /repos/${{ inputs.STATUS_REPO_OWNER }}/${{ inputs.STATUS_REPOSITORY }}/statuses/${{ github.sha }} \
          -f "state=success" \
          -f "description=Build Succeeded" \
          -f "target_url=${{ env.PIPELINE_CONSOLE_URL }}"

      - name: Failed Status
        if: ${{ failure() && github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token-2.outputs.token }}
        run: |
          gh api --method POST \
          /repos/${{ inputs.STATUS_REPO_OWNER }}/${{ inputs.STATUS_REPOSITORY }}/statuses/${{ github.sha }} \
          -f "state=failure" \
          -f "description=Build Failed" \
          -f "target_url=${{ env.PIPELINE_CONSOLE_URL }}"

      - name: Cancelled Status
        if: ${{ cancelled() && github.event.inputs.STATUS_REPO_OWNER != '' && github.event.inputs.STATUS_REPOSITORY != '' }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token-2.outputs.token }}
        run: |
          gh api --method POST \
          /repos/${{ inputs.STATUS_REPO_OWNER }}/${{ inputs.STATUS_REPOSITORY }}/statuses/${{ github.sha }} \
          -f "state=failure" \
          -f "description=Build Cancelled" \
          -f "target_url=${{ env.PIPELINE_CONSOLE_URL }}"

      - name: Stop CodePipeline on Workflow Cancellation
        if: cancelled()
        run: |
          PIPELINE_NAME=${{ steps.pipeline-deploy.outputs.PipelineName }}
          aws codepipeline stop-pipeline-execution \
            --pipeline-name  $PIPELINE_NAME \
            --pipeline-execution-id ${{ env.EXECUTION_ID }} \
            --abandon

          # Wait a moment for the pipeline to process
          sleep 5

          # Get pipeline structure to find CodeBuild projects
          CODEBUILD_PROJECTS=$(aws codepipeline get-pipeline \
              --name "$PIPELINE_NAME" \
              --query 'pipeline.stages[].actions[?actionTypeId.provider==`CodeBuild`].configuration.ProjectName' \
              --output text)

          echo "Found CodeBuild projects: $CODEBUILD_PROJECTS"

          # Stop running builds for each CodeBuild project
          for project in $CODEBUILD_PROJECTS; do
              echo "Checking builds for project: $project"

              # Get running builds for this project
              RUNNING_BUILDS=$(aws codebuild list-builds-for-project \
                  --project-name "$project" \
                  --sort-order DESCENDING \
                  --query 'ids[0:5]' \
                  --output text)

              for build_id in $RUNNING_BUILDS; do
                  if [ -n "$build_id" ]; then
                      # Check if build is still running
                      BUILD_STATUS=$(aws codebuild batch-get-builds \
                          --ids "$build_id" \
                          --query 'builds[0].buildStatus' \
                          --output text)

                      if [ "$BUILD_STATUS" = "IN_PROGRESS" ]; then
                          echo "Stopping running build: $build_id"
                          aws codebuild stop-build --id "$build_id"
                      fi
                  fi
              done
          done

...
